Credit to FoxOnTop for most of the code
